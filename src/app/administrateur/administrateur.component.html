<mat-icon class="homeIcon" (click)="navigateToHome()">home </mat-icon>

<div class="search-container">
  <div class="searchPeriod">
    <!-- Filtre par période -->
    <mat-form-field appearance="outline">
      <mat-label>Périodes</mat-label>
      <mat-select placeholder="Choisissez une période">
        <mat-option></mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Catégorie d'ages</mat-label>
      <mat-select
        placeholder="Choisissez une catégorie d'age"
        (selectionChange)="selectedAgeGroup.set($event.value)"
      >
        <mat-option value="">Toutes les catégories d'ages</mat-option>
        <mat-option *ngFor="let age of ageGroups()" [value]="age">
          {{ age }} - {{ getAgeMax(age) }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <!-- Filtre par thème -->
    <mat-form-field appearance="outline">
      <mat-label>Filtrer par thème</mat-label>
      <mat-select
        placeholder="Choisissez un thème"
        [value]="selectedTheme()"
        (valueChange)="selectedTheme.set($event)"
      >
        <mat-option [value]="null">Tous les thèmes</mat-option>
        <mat-option *ngFor="let theme of themes()" [value]="theme">
          {{ theme }}
        </mat-option>
      </mat-select>
    </mat-form-field>
  </div>
</div>

<!-- TABLEAU -->
<div class="table-container">
  <h2>Gestion des Stages</h2>

  <!-- Tableau principal des descriptions -->
  <table
    mat-table
    [dataSource]="filteredDataSource()"
    class="mat-elevation-8 stage-table"
  >
    <!-- Colonne id -->
    <ng-container matColumnDef="idStageDesc">
      <th mat-header-cell *matHeaderCellDef>Id</th>
      <td mat-cell *matCellDef="let element">{{ element.idStageDesc }}</td>
    </ng-container>

    <!-- Colonne Titre -->
    <ng-container matColumnDef="titre">
      <th mat-header-cell *matHeaderCellDef>Titre</th>
      <td mat-cell *matCellDef="let element">{{ element.titre }}</td>
    </ng-container>

    <!-- Colonne Thème -->
    <ng-container matColumnDef="theme">
      <th mat-header-cell *matHeaderCellDef>Thème</th>
      <td mat-cell *matCellDef="let element">{{ element.theme }}</td>
    </ng-container>

    <!-- Colonne Description -->
    <ng-container matColumnDef="description">
      <th mat-header-cell *matHeaderCellDef>Description</th>
      <td mat-cell *matCellDef="let element" class="description-cell">
        {{ element.description }}
      </td>
    </ng-container>

    <!-- Colonne Âge Min -->
    <ng-container matColumnDef="ageMin">
      <th mat-header-cell *matHeaderCellDef>Âge Min</th>
      <td mat-cell *matCellDef="let element">{{ element.ageMin }} ans</td>
    </ng-container>

    <!-- Colonne Âge Max -->
    <ng-container matColumnDef="ageMax">
      <th mat-header-cell *matHeaderCellDef>Âge Max</th>
      <td mat-cell *matCellDef="let element">{{ element.ageMax }} ans</td>
    </ng-container>

    <!-- Colonne Expand/Collapse -->
    <ng-container matColumnDef="expand">
      <th mat-header-cell *matHeaderCellDef aria-label="row actions">
        <button
          mat-icon-button
          class=""
          color="secondary"
          disabled="false"
          [routerLink]="'/createstagedesc'"
        >
          <mat-icon svgIcon="more"></mat-icon>
        </button>
      </th>
      <td mat-cell *matCellDef="let element">
        <button
          mat-icon-button
          (click)="toggleRow(element)"
          [attr.aria-label]="
            expandedElement() === element ? 'Réduire' : 'Développer'
          "
          [attr.aria-expanded]="expandedElement() === element"
        >
          <mat-icon *ngIf="expandedElement() !== element">expand_more</mat-icon>
          <mat-icon *ngIf="expandedElement() === element">expand_less</mat-icon>
        </button>
      </td>
    </ng-container>

    <!-- Ligne d'expansion pour les instances -->
    <ng-container matColumnDef="expandedDetail">
      <td
        mat-cell
        *matCellDef="let element"
        [attr.colspan]="displayedColumns.length"
      >
        <div
          class="example-element-detail"
          [@detailExpand]="
            element.element === expandedElement() ? 'expanded' : 'collapsed'
          "
        >
          <!-- Titre des instances -->
          <div class="instances-header">
            <h3 class="instances-title">
              Instances disponibles ({{
                element.element.instances?.length || 0
              }})
            </h3>
            <div class="create-instance">
              <button
                mat-stroked-button
                class="small"
                color="neutral"
                disabled="false"
                (click)="logElementId(element)"
                [routerLink]="['/createstageinst', element.element.idStageDesc]"
              >
                <mat-icon svgIcon="more"></mat-icon>
                Créer une instance
              </button>
            </div>
          </div>

          <!-- Tableau des instances -->
          <div
            *ngIf="
              element.element.instances && element.element.instances.length > 0;
              else noInstances
            "
            class="instances-table"
          >
            <table
              mat-table
              [dataSource]="element.element.instances"
              class="instances-nested-table"
            >
              <!-- Colonne Prix -->
              <ng-container matColumnDef="prix">
                <th mat-header-cell *matHeaderCellDef>Prix</th>
                <td mat-cell *matCellDef="let instance">
                  {{ instance.prix }}€
                </td>
              </ng-container>

              <!-- Colonne Date Début -->
              <ng-container matColumnDef="dateDebut">
                <th mat-header-cell *matHeaderCellDef>Date Début</th>
                <td mat-cell *matCellDef="let instance">
                  {{ instance.dateDebut | date : "dd/MM/yyyy" }}
                </td>
              </ng-container>

              <!-- Colonne Statut -->
              <ng-container matColumnDef="statut">
                <th mat-header-cell *matHeaderCellDef>Statut</th>
                <td mat-cell *matCellDef="let instance">
                  <span
                    class="status-badge"
                    [ngClass]="instance.statut ? 'active' : 'inactive'"
                  >
                    {{ instance.statut ? "Actif" : "Inactif" }}
                  </span>
                </td>
              </ng-container>

              <!-- Colonne Participants -->
              <ng-container matColumnDef="nbrParticipant">
                <th mat-header-cell *matHeaderCellDef>Places</th>
                <td mat-cell *matCellDef="let instance">
                  {{ instance.nbrParticipant }}
                </td>
              </ng-container>

              <!-- Colonne Inscrits -->
              <ng-container matColumnDef="nbrInscrit">
                <th mat-header-cell *matHeaderCellDef>Inscrits</th>
                <td mat-cell *matCellDef="let instance">
                  <span
                    [ngClass]="
                      instance.nbrInscrit >= instance.nbrParticipant
                        ? 'full'
                        : 'available'
                    "
                  >
                    {{ instance.nbrInscrit }} / {{ instance.nbrParticipant }}
                  </span>
                </td>
              </ng-container>

              <!-- Actions sur les instances -->
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef>Actions</th>
                <td mat-cell *matCellDef="let instance">
                  <button
                    mat-button
                    color="primary"
                    size="small"
                    [routerLink]="[
                      '/editstageinst',
                      element.element.idStageDesc
                    ]"
                  >
                    <mat-icon>edit</mat-icon>
                    Modifier
                  </button>
                  <button mat-button color="warn" size="small">
                    <mat-icon>delete</mat-icon>
                    Supprimer
                  </button>
                </td>
              </ng-container>

              <!-- En-tête et lignes du tableau des instances -->
              <tr
                mat-header-row
                *matHeaderRowDef="displayedInstanceColumns"
              ></tr>
              <tr
                mat-row
                *matRowDef="let row; columns: displayedInstanceColumns"
              ></tr>
            </table>
          </div>

          <!-- Message si aucune instance -->
          <ng-template #noInstances>
            <div class="no-instances">
              <mat-icon>info</mat-icon>
              <p>Aucune instance disponible pour ce stage</p>
            </div>
          </ng-template>
        </div>
      </td>
    </ng-container>

    <!-- En-tête du tableau principal -->
    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>

    <!-- Lignes du tableau principal -->
    <tr
      mat-row
      *matRowDef="let element; columns: displayedColumns; when: isDataRow"
      [class.example-expanded-row]="expandedElement() === element"
      (click)="toggleRow(element)"
    ></tr>

    <!-- Ligne d'expansion -->
    <tr
      mat-row
      *matRowDef="
        let row;
        columns: ['expandedDetail'];
        when: isExpansionDetailRow
      "
      class="example-detail-row"
    ></tr>
  </table>

  <!-- Message si aucune données -->
  <div *ngIf="dataSource().length === 0" class="no-data">
    <mat-icon>inbox</mat-icon>
    <h3>Aucun stage trouvé</h3>
    <p>Il n'y a actuellement aucun stage disponible.</p>
  </div>
</div>
